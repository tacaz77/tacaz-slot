<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>NEON STRIKE SLOT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #050505; color: #fff; overflow: hidden; }
        .slot-machine { background: #111; border-radius: 40px; border: 4px solid #222; box-shadow: 0 0 50px rgba(0,0,0,1); }
        .reel-container { height: 360px; overflow: hidden; position: relative; background: #000; }
        .reel { transition: transform 3s cubic-bezier(0.1, 0, 0.1, 1); }
        .symbol { height: 120px; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; filter: drop-shadow(0 0 5px rgba(255,255,255,0.1)); }
        .win-line { position: absolute; top: 50%; left: 0; width: 100%; h-1 bg-yellow-500/50 shadow-[0_0_15px_yellow] z-30 opacity-0 transition-opacity; }
        .active-win { opacity: 1; animation: blink 0.2s infinite; }
        @keyframes blink { 50% { opacity: 0.2; } }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="text-center mb-10">
        <h1 class="text-5xl font-black italic tracking-tighter text-yellow-500 drop-shadow-[0_0_15px_rgba(234,179,8,0.5)]">NEON STRIKE</h1>
        <p class="text-[10px] tracking-[0.4em] text-gray-500 uppercase mt-2">Experimental Hacksaw Engine</p>
    </div>

    <div class="slot-machine p-4 relative w-full max-w-sm">
        <div class="win-line" id="winLine"></div>
        <div class="flex gap-2 rounded-3xl overflow-hidden relative">
            <div class="reel-container flex-1"><div id="reel-0" class="reel"></div></div>
            <div class="reel-container flex-1"><div id="reel-1" class="reel"></div></div>
            <div class="reel-container flex-1"><div id="reel-2" class="reel"></div></div>
        </div>
    </div>

    <div class="mt-12 flex gap-10 items-center w-full max-w-sm justify-between px-4">
        <div class="text-left">
            <p class="text-[10px] text-gray-500 uppercase">Credits</p>
            <p id="balance" class="text-3xl font-bold text-yellow-500 tracking-tighter">${{ balance }}</p>
        </div>
        
        <button id="spinBtn" onclick="handleSpin()" class="w-24 h-24 bg-yellow-500 rounded-full border-b-8 border-yellow-700 flex items-center justify-center active:border-b-0 active:translate-y-2 transition-all shadow-2xl">
            <span class="text-black font-black text-2xl uppercase">Spin</span>
        </button>

        <div class="text-right">
            <p class="text-[10px] text-gray-500 uppercase">Win</p>
            <p id="lastWin" class="text-3xl font-bold text-green-500 tracking-tighter">$0</p>
        </div>
    </div>

    <script>
        const SYMBOLS = [
            { s: 'üçí', w: 15, v: 2 },  { s: 'üçã', w: 12, v: 5 },
            { s: 'üíé', w: 4, v: 25 },  { s: '7Ô∏è‚É£', w: 1, v: 100 }
        ];

        let balance = {{ balance }};
        const reels = [document.getElementById('reel-0'), document.getElementById('reel-1'), document.getElementById('reel-2')];

        function init() {
            reels.forEach(r => {
                let content = '';
                for(let i=0; i<80; i++) {
                    const s = SYMBOLS[Math.floor(Math.random() * SYMBOLS.length)].s;
                    content += `<div class="symbol">${s}</div>`;
                }
                r.innerHTML = content;
            });
        }

        async function handleSpin() {
            if(balance < 100) return alert("Low balance");
            
            const btn = document.getElementById('spinBtn');
            btn.disabled = true;
            document.getElementById('winLine').classList.remove('active-win');
            document.getElementById('lastWin').innerText = '$0';

            // –°–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            const res = await fetch('/spin', { method: 'POST' });
            if(!res.ok) return;
            const data = await res.json();
            balance = data.new_balance;
            document.getElementById('balance').innerText = `$${balance}`;

            const stopPositions = [];
            reels.forEach((r, i) => {
                const stopAt = Math.floor(Math.random() * 50) + 20;
                r.style.transition = `transform ${2 + i*0.8}s cubic-bezier(0.1, 0, 0.1, 1)`;
                r.style.transform = `translateY(-${stopAt * 120}px)`;
                
                setTimeout(() => {
                    const symbolIndex = stopAt + 1;
                    stopPositions.push(r.children[symbolIndex].innerText);
                    if(stopPositions.length === 3) processResult(stopPositions);
                }, 2000 + i*800);
            });
        }

        async function processResult(res) {
            document.getElementById('spinBtn').disabled = false;
            if(res[0] === res[1] && res[1] === res[2]) {
                const config = SYMBOLS.find(s => s.s === res[0]);
                const winAmt = 100 * config.v;
                
                // –í–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
                document.getElementById('winLine').classList.add('active-win');
                document.getElementById('lastWin').innerText = `+$${winAmt}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                const s_res = await fetch('/win', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({amount: winAmt})
                });
                const s_data = await s_res.json();
                balance = s_data.new_balance;
                document.getElementById('balance').innerText = `$${balance}`;
            }
        }

        init();
    </script>
</body>
</html>
